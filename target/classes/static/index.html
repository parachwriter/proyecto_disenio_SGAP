<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <title>SGAP - Gestión de Proyectos</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        .module {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        form {
            display: flex;
            flex-direction: column;
            max-width: 400px;
            gap: 10px;
        }

        hr {
            width: 100%;
            margin: 10px 0;
        }

        .btn-volver {
            margin-bottom: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <button class="btn-volver" onclick="window.location.href='dashboard.html'">← Volver al Panel</button>

    <h1>Sistema SGAP</h1>

    <div class="module">
        <h2>Registro de Proyecto (Jefe de Departamento)</h2>
        <form id="formProyecto">
            <input type="text" id="nombreP" placeholder="Nombre del Proyecto" required>
            <input type="number" id="presupuestoP" placeholder="Presupuesto" required>
            <input type="number" id="maxAsistentesP" placeholder="Máximo de Asistentes" required
                title="Límite de asistentes permitido">
            <label for="fechaInicioP">Fecha Inicio:</label>
            <input type="date" id="fechaInicioP" required>
            <label for="fechaFinP">Fecha Fin:</label>
            <input type="date" id="fechaFinP" required>
            <hr>
            <small>Datos del Director a asignar:</small>
            <input type="text" id="nombreD" placeholder="Nombre del Director" required>
            <input type="email" id="correoD" placeholder="Correo Institucional" required>
            <input type="text" id="cedulaD" placeholder="Cédula" required>

            <input type="text" id="areaD" placeholder="Área de Investigación (Ej: IA, Software)" required>

            <button type="submit">Registrar Proyecto y Notificar Director</button>
        </form>
    </div>

    <script>
        // --- ESTO ES EL INICIO AL QUE ME REFERÍA ---
        // Verifica si el usuario inició sesión como admin
        if (localStorage.getItem("sesion") !== "admin") {
            window.location.href = 'login.html';
        }
        // -------------------------------------------

        document.getElementById('formProyecto').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                nombre: document.getElementById('nombreP').value,
                presupuesto: parseFloat(document.getElementById('presupuestoP').value),
                // NUEVOS CAMPOS
                maxAsistentes: parseInt(document.getElementById('maxAsistentesP').value),
                fechaInicio: document.getElementById('fechaInicioP').value,
                fechaFin: document.getElementById('fechaFinP').value,

                director: {
                    nombre: document.getElementById('nombreD').value,
                    correoInstitucional: document.getElementById('correoD').value,
                    cedula: document.getElementById('cedulaD').value,
                    areaInvestigacion: document.getElementById('areaD').value
                }
            };

            try {
                const res = await fetch('/proyectos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const msg = await res.text();
                    alert("Éxito: " + msg);
                    location.reload();
                } else {
                    const errorMsg = await res.text();
                    alert("Error del servidor: " + errorMsg);
                }
            } catch (err) {
                alert("Error al conectar con el servidor");
            }
        });
    </script>
</body>

</html>