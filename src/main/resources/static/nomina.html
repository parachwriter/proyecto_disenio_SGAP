<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGAP - Nómina Mensual</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="none"/><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.05)"/></svg>');
      opacity: 0.3;
      top: 0;
      left: 0;
      z-index: 0;
    }

    .logo-stamp {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 70px;
      height: 70px;
      background: white;
      border-radius: 50%;
      padding: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-stamp img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      margin-top: 60px;
    }

    .topbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem 2.5rem;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .topbar h1 {
      color: #2d3748;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.5px;
    }

    .muted {
      color: #718096;
      font-size: 0.95rem;
    }

    .topbar-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem 2.5rem;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      margin-bottom: 1.5rem;
    }

    .card h3 {
      color: #2d3748;
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card h3::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      border-radius: 2px;
    }

    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1rem;
    }

    .row label {
      color: #4a5568;
      font-weight: 600;
      font-size: 0.95rem;
    }

    input,
    select {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
      color: #2d3748;
      min-width: 180px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #48bb78;
      box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
    }

    button {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      border: 2px solid #48bb78;
      background: white;
      color: #48bb78;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    button:hover {
      background: #48bb78;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
    }

    .btn-baja {
      border-color: #f56565;
      color: #f56565;
    }

    .btn-baja:hover {
      background: #f56565;
      color: white;
      box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
    }

    .btn-restaurar {
      border-color: #4299e1;
      color: #4299e1;
    }

    .btn-restaurar:hover {
      background: #4299e1;
      color: white;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
    }

    .btn-seleccionar {
      border-color: #667eea;
      color: #667eea;
    }

    .btn-seleccionar:hover {
      background: #667eea;
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      border-color: #718096;
      color: #718096;
    }

    .btn-secondary:hover {
      background: #718096;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
      color: #2d3748;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      color: #4a5568;
      font-size: 0.95rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: #f7fafc;
    }

    .pill {
      display: inline-block;
      padding: 0.35rem 0.85rem;
      border-radius: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .status-activo {
      color: #48bb78;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .status-fuera {
      color: #f56565;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .seccion-oculta {
      display: none;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.activo {
      display: flex;
    }

    .modal-contenido {
      background: white;
      padding: 3rem 2.5rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      text-align: center;
      max-width: 500px;
      width: 90%;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-titulo {
      font-size: 2rem;
      color: #48bb78;
      margin-bottom: 1.5rem;
      font-weight: 700;
    }

    .modal-mensaje {
      font-size: 1.1rem;
      color: #4a5568;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .modal-boton {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 0.85rem 2.5rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    }

    .modal-boton:hover {
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5);
    }

    .confirm-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e2e8f0;
    }

    @media (max-width: 768px) {
      .logo-stamp {
        width: 55px;
        height: 55px;
        top: 15px;
        left: 15px;
      }

      .container {
        margin-top: 50px;
      }

      .topbar {
        padding: 1.5rem;
        flex-direction: column;
        align-items: stretch;
      }

      .topbar h1 {
        font-size: 1.4rem;
      }

      .topbar-actions {
        justify-content: stretch;
      }

      .topbar-actions button {
        flex: 1;
      }

      .card {
        padding: 1.5rem;
      }

      .card h3 {
        font-size: 1.1rem;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .row label {
        margin-bottom: 0.25rem;
      }

      input,
      select {
        width: 100%;
        min-width: unset;
      }

      button {
        width: 100%;
      }

      table {
        font-size: 0.85rem;
      }

      th,
      td {
        padding: 0.75rem 0.5rem;
      }

      .confirm-section {
        flex-direction: column;
        gap: 1rem;
      }

      .confirm-section button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- Logo en esquina superior izquierda -->
  <div class="logo-stamp">
    <img src="SGAP.png" alt="SGAP Logo">
  </div>

  <div class="container">
    <div class="topbar">
      <div>
        <h1>Gestión de Nómina Mensual</h1>
        <div class="muted" id="bienvenida"></div>
      </div>
      <div class="topbar-actions">
        <button class="btn-secondary" onclick="window.location.href='menu-director.html'">← Volver</button>
        <button class="btn-baja" onclick="localStorage.clear(); window.location.href='login.html'">Cerrar Sesión</button>
      </div>
    </div>

    <div class="card">
      <h3>Selección de Proyecto y Periodo</h3>
      <div class="row">
        <label>Proyecto:</label>
        <select id="selectProyecto" onchange="cargarMesesAtrasados()">
          <option value="">Cargando sus proyectos...</option>
        </select>
      </div>
      <div class="row">
        <label>Año:</label>
        <select id="anio" onchange="actualizarMesesPorAnio()">
          <option value="">Seleccione un año primero</option>
        </select>
        <label>Mes:</label>
        <select id="mes">
          <option value="">Seleccione un año primero</option>
        </select>
        <button class="btn-seleccionar" onclick="seleccionarPeriodo()">Seleccionar Período</button>
      </div>
    </div>

    <div class="card seccion-oculta" id="seccionContratacion">
      <h3>Reportar Nueva Contratación</h3>
      <div class="row">
        <label for="tipoIntegrante" style="min-width: auto;">Tipo de Contrato:</label>
        <select id="tipoIntegrante" style="min-width: 200px;">
          <option value="ASISTENTE">Asistente</option>
          <option value="AYUDANTE">Ayudante de Investigación</option>
          <option value="TECNICO">Técnico de Investigación</option>
        </select>
      </div>
      <div class="row">
        <input type="text" id="nomA" placeholder="Nombre completo" maxlength="100" />
        <input type="text" id="cedA" placeholder="Cédula" maxlength="10" />
        <input type="date" id="fechaNacA" />
        <button class="btn-primary" onclick="agregarAsistente()">+ Agregar Integrante</button>
      </div>
    </div>

    <div class="card seccion-oculta" id="seccionAsistentes">
      <div class="confirm-section">
        <h3 style="margin: 0; border: none; padding: 0;">Asistentes en Nómina (Este Mes)</h3>
        <button class="btn-primary" onclick="confirmarNomina()">✓ CONFIRMAR ACTUALIZACIÓN MENSUAL</button>
      </div>

      <table id="tablaAsistentes">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Cédula</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbodyAsistentes">
          <tr>
            <td colspan="5" class="muted" style="text-align: center; padding: 2rem;">
              Seleccione un proyecto para ver los asistentes activos.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de éxito -->
  <div class="modal-overlay" id="modalExito">
    <div class="modal-contenido">
      <div class="modal-titulo">✓ Éxito</div>
      <div class="modal-mensaje" id="mensajeModal"></div>
      <button class="modal-boton" onclick="cerrarModal()">Aceptar</button>
    </div>
  </div>

  <script>
    // Verificación de sesión
    if (localStorage.getItem("sesion") !== "director") {
      window.location.href = "login.html";
    }

    const emailDir = localStorage.getItem("userEmail");
    document.getElementById("bienvenida").innerText = "Director: " + emailDir;

    // Variable global para almacenar proyectos
    let proyectosGlobal = [];

    // VALIDACIONES EN TIEMPO REAL
    document.addEventListener('DOMContentLoaded', function() {
      // Validar nombre: solo letras y espacios
      const inputNombre = document.getElementById("nomA");
      if (inputNombre) {
        inputNombre.addEventListener('input', function() {
          this.value = this.value.replace(/[^a-záéíóúñ\s]/gi, '');
        });
      }

      // Validar cédula: solo números
      const inputCedula = document.getElementById("cedA");
      if (inputCedula) {
        inputCedula.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '');
        });
      }
    });

    // 1. CARGAR PROYECTOS (Ruta corregida: /proyectos/director/...)
    window.onload = async () => {
      try {
        const res = await fetch(`/proyectos/director/${emailDir}`);
        if (!res.ok) throw new Error("Error en la respuesta del servidor");

        const proyectos = await res.json();
        console.log("Proyectos cargados del servidor:", proyectos);
        
        // Guardar en variable global
        proyectosGlobal = proyectos;
        
        const select = document.getElementById("selectProyecto");

        if (!proyectos || proyectos.length === 0) {
          select.innerHTML = "<option value=''>No tiene proyectos asignados</option>";
          return;
        }

        console.log("Primer proyecto:", proyectos[0]);
        console.log("Keys del primer proyecto:", Object.keys(proyectos[0]));
        
        // Crear opciones con mejor debugging
        const opciones = proyectos.map(p => {
          console.log("Procesando proyecto:", p, "id=", p.id, "nombre=", p.nombre);
          return `<option value="${p.id}">${p.nombre}</option>`;
        }).join("");
        
        console.log("HTML de opciones:", opciones);
        select.innerHTML = opciones;
        
        // Mostrar el primer proyecto seleccionado
        if (select.options.length > 0) {
          select.selectedIndex = 0;
          console.log("Opción 0 value:", select.options[0].value);
          // Disparar el evento change para cargar meses
          select.dispatchEvent(new Event('change'));
        }
        
      } catch (e) {
        console.error("Error cargando proyectos", e);
        document.getElementById("selectProyecto").innerHTML = "<option value=''>Error al conectar con el servidor</option>";
      }
    };

    // 2. CARGAR MESES ATRASADOS DEL PROYECTO
    let mesesAtrasadosGlobal = []; // Variable global para almacenar los meses
    
    async function cargarMesesAtrasados() {
      const pId = document.getElementById("selectProyecto").value;
      console.log("Cargando meses para proyecto:", pId);
      
      if (!pId) {
        document.getElementById("mes").innerHTML = "<option value=''>Seleccione un proyecto primero</option>";
        document.getElementById("anio").innerHTML = "<option value=''>Seleccione un proyecto primero</option>";
        return;
      }

      try {
        // Obtener meses atrasados
        const resMeses = await fetch(`/api/nomina/meses-atrasados/${pId}`);
        console.log("Status respuesta:", resMeses.status);
        
        const mesesAtrasados = await resMeses.json();
        console.log("Meses atrasados obtenidos:", mesesAtrasados);

        if (!mesesAtrasados || mesesAtrasados.length === 0) {
          console.log("No hay meses atrasados");
          document.getElementById("mes").innerHTML = "<option value=''>Todos los períodos están actualizados</option>";
          document.getElementById("anio").innerHTML = "<option value=''>Todos los períodos están actualizados</option>";
          return;
        }

        // Guardar en variable global
        mesesAtrasadosGlobal = mesesAtrasados;

        // Agrupar meses por año
        const años = new Set();
        mesesAtrasados.forEach(m => años.add(m.anio));
        console.log("Años encontrados:", Array.from(años));

        // Llenar select de años
        const opcionesAnios = Array.from(años).sort((a, b) => b - a).map(a => 
          `<option value="${a}">${a}</option>`
        ).join("");
        document.getElementById("anio").innerHTML = opcionesAnios;

        // Limpiar select de meses
        document.getElementById("mes").innerHTML = "<option value=''>Seleccione un año primero</option>";

        // Seleccionar el primer año automáticamente
        const primerAnio = Array.from(años).sort((a, b) => b - a)[0];
        console.log("Primer año:", primerAnio);
        
        if (primerAnio) {
          document.getElementById("anio").value = primerAnio;
          actualizarMesesPorAnio();
        }

      } catch (e) {
        console.error("Error cargando meses atrasados:", e);
        alert("Error al cargar meses atrasados. Revisa la consola (F12) para más detalles.");
        document.getElementById("mes").innerHTML = "<option value=''>Error al cargar meses</option>";
        document.getElementById("anio").innerHTML = "<option value=''>Error al cargar años</option>";
      }
    }

    // Función para actualizar meses cuando cambia el año
    function actualizarMesesPorAnio() {
      const anioSeleccionado = parseInt(document.getElementById("anio").value);
      console.log("Actualizando meses para año:", anioSeleccionado);
      console.log("Meses globales:", mesesAtrasadosGlobal);
      
      if (!anioSeleccionado || !mesesAtrasadosGlobal || mesesAtrasadosGlobal.length === 0) {
        document.getElementById("mes").innerHTML = "<option value=''>Seleccione un año primero</option>";
        return;
      }

      const mesesDelAnio = mesesAtrasadosGlobal.filter(m => m.anio === anioSeleccionado);
      console.log("Meses para el año " + anioSeleccionado + ":", mesesDelAnio);
      
      if (mesesDelAnio.length === 0) {
        document.getElementById("mes").innerHTML = "<option value=''>No hay meses atrasados para este año</option>";
        return;
      }

      const opciones = mesesDelAnio.map(m => 
        `<option value="${m.mes}">${m.etiqueta}</option>`
      ).join("");
      console.log("Opciones HTML generadas:", opciones);
      document.getElementById("mes").innerHTML = opciones;
    }


    // 3. CARGAR ASISTENTES DEL PROYECTO
    async function cargarAsistentesDelProyecto() {
      const pId = document.getElementById("selectProyecto").value;
      if (!pId) return;

      const tbody = document.getElementById("tbodyAsistentes");

      try {
        // Ahora busca TODOS los asistentes activos del proyecto
        const res = await fetch(`/api/nomina/asistentes-activos/${pId}`);
        const asistentes = await res.json();

        if (asistentes.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5' style='text-align: center; padding: 2rem;'>No hay asistentes registrados como activos en este proyecto.</td></tr>";
          return;
        }

        tbody.innerHTML = asistentes.map(a => `
        <tr data-id="${a.id}">
          <td>${a.id}</td>
          <td>${a.nombre}</td>
          <td>${a.cedula}</td>
          <td class="${a.estado === 'ACTIVO' ? 'status-activo' : 'status-fuera'}">${a.estado}</td>
          <td>
            ${a.estado === 'ACTIVO' ? `<button class="btn-baja" onclick="darDeBaja(${a.id})">Dar de Baja</button>` : '---'}
          </td>
        </tr>
      `).join("");
      } catch (e) {
        console.error("Error al cargar asistentes:", e);
        tbody.innerHTML = "<tr><td colspan='5' style='text-align: center; padding: 2rem;'>Error al cargar asistentes.</td></tr>";
      }
    }

    // 3. AGREGAR ASISTENTE (Solo visual en el Front)
    function agregarAsistente() {
      const pId = document.getElementById("selectProyecto").value;
      const tipoIntegrante = document.getElementById("tipoIntegrante").value;
      const nombre = document.getElementById("nomA").value;
      const cedula = document.getElementById("cedA").value;
      const fechaNac = document.getElementById("fechaNacA").value;

      if (!nombre || !cedula || !fechaNac || !pId || !tipoIntegrante) return alert("Complete todos los datos y seleccione proyecto");

      // Obtener proyecto actual
      const proyectoActual = proyectosGlobal.find(p => p.id == pId);
      if (!proyectoActual) return alert("Proyecto no encontrado");

      const maxAsistentes = proyectoActual.maxAsistentes;
      console.log("Máximo asistentes permitidos:", maxAsistentes);

      const tbody = document.getElementById("tbodyAsistentes");

      // Contar asistentes ACTIVOS en la tabla (no incluye los dados de baja)
      const asistentesActivos = Array.from(tbody.querySelectorAll("tr")).filter(row => {
        const estadoCell = row.cells[3];
        return estadoCell && estadoCell.classList.contains("status-activo");
      }).length;

      console.log("Asistentes activos actualmente:", asistentesActivos);

      // Validar si se alcanzó el máximo
      if (asistentesActivos >= maxAsistentes) {
        alert(`No puedes agregar más asistentes. Máximo permitido: ${maxAsistentes}. Actualmente tienes ${asistentesActivos}.`);
        return;
      }

      // Si la tabla tenía el mensaje de "No hay asistentes", lo borramos
      if (tbody.rows[0]?.cells.length === 1) tbody.innerHTML = "";

      // Determinar el tipo de integrante para mostrar
      let tipoTexto = tipoIntegrante === 'ASISTENTE' ? 'Asistente' : 
                      tipoIntegrante === 'AYUDANTE' ? 'Ayudante' : 'Técnico';

      // Insertamos la fila en la tabla sin ir al servidor todavía
      const nuevaFila = `
    <tr data-id="NUEVO">
      <td><span class="pill">NUEVO</span></td>
      <td class="cell-nombre">${nombre}</td>
      <td class="cell-cedula">${cedula}</td>
      <td class="status-activo">ACTIVO (${tipoTexto})</td>
      <td>
        <button class="btn-baja" onclick="eliminarFilaTemporal(this)">Remover</button>
        <input type="hidden" class="hidden-fecha-nac" value="${fechaNac}">
        <input type="hidden" class="hidden-tipo-integrante" value="${tipoIntegrante}">
      </td>
    </tr>
  `;
      tbody.innerHTML += nuevaFila;

      // Limpiar campos
      document.getElementById("nomA").value = "";
      document.getElementById("cedA").value = "";
      document.getElementById("fechaNacA").value = "";
    }

    function eliminarFilaTemporal(boton) {
      boton.closest('tr').remove();
    }

    // 4. DAR DE BAJA UN ASISTENTE (Solo visual, sin guardar en BD todavía)
    function darDeBaja(idAsistente) {
      const fila = document.querySelector(`tr[data-id="${idAsistente}"]`);
      const nombreAsistente = fila.cells[1].innerText.trim();

      // Mostrar confirmación
      const confirmar = confirm(`¿Estás seguro de dar de baja a "${nombreAsistente}"?`);
      
      if (!confirmar) return;

      // Cambiar el estado visual SOLO en el frontend
      const estadoCell = fila.cells[3];
      const accionCell = fila.cells[4];
      
      // Cambiar el estado visual
      estadoCell.className = 'status-fuera';
      estadoCell.innerText = 'FUERA_NOMINA';
      
      // Cambiar el botón a restaurar
      accionCell.innerHTML = `<button class="btn-restaurar" onclick="restaurarAsistente(${idAsistente})">Restaurar</button>`;
    }

    // 5. RESTAURAR UN ASISTENTE (Deshacer dar de baja)
    function restaurarAsistente(idAsistente) {
      const fila = document.querySelector(`tr[data-id="${idAsistente}"]`);
      const nombreAsistente = fila.cells[1].innerText.trim();

      // Obtener proyecto actual para validar máximo
      const pId = document.getElementById("selectProyecto").value;
      const proyectoActual = proyectosGlobal.find(p => p.id == pId);
      if (!proyectoActual) {
        alert("Proyecto no encontrado");
        return;
      }

      const maxAsistentes = proyectoActual.maxAsistentes;
      const tbody = document.getElementById("tbodyAsistentes");

      // Contar asistentes ACTIVOS actuales (sin contar el que vamos a restaurar)
      const asistentesActivos = Array.from(tbody.querySelectorAll("tr")).filter(row => {
        const estadoCell = row.cells[3];
        return estadoCell && estadoCell.classList.contains("status-activo");
      }).length;

      // Validar si al restaurar excederíamos el máximo
      if (asistentesActivos >= maxAsistentes) {
        alert(`No puedes restaurar más asistentes. Máximo permitido: ${maxAsistentes}. Actualmente tienes ${asistentesActivos} activos.`);
        return;
      }

      // Confirmar restauración
      const confirmar = confirm(`¿Restaurar a "${nombreAsistente}" a ACTIVO?`);
      if (!confirmar) return;

      // Revertir cambios visuales
      const estadoCell = fila.cells[3];
      const accionCell = fila.cells[4];
      
      estadoCell.className = 'status-activo';
      estadoCell.innerText = 'ACTIVO';
      
      accionCell.innerHTML = `<button class="btn-baja" onclick="darDeBaja(${idAsistente})">Dar de Baja</button>`;
    }

    async function confirmarNomina() {
      console.log("=== INICIO confirmarNomina ===");
      console.log("document:", document);
      console.log("document.getElementById:", document.getElementById);
      
      // Buscar el elemento de múltiples formas
      let selectProyecto = document.getElementById("selectProyecto");
      console.log("getElementById('selectProyecto'):", selectProyecto);
      
      if (!selectProyecto) {
        console.log("No encontrado por id, buscando por query...");
        selectProyecto = document.querySelector("select");
        console.log("querySelector('select'):", selectProyecto);
      }
      
      if (!selectProyecto) {
        console.log("TODOS los selects en la página:");
        console.log(document.querySelectorAll("select"));
        return alert("ERROR: No se encontró el select de proyecto. Revisa F12 console para más info.");
      }

      console.log("Select encontrado:", selectProyecto);
      console.log("Select id:", selectProyecto.id);
      console.log("Select class:", selectProyecto.className);
      
      const proyectoId = selectProyecto.value;
      const mes = document.getElementById("mes").value;
      const anio = document.getElementById("anio").value;

      console.log("Valores obtenidos:");
      console.log("  proyectoId:", proyectoId, "tipo:", typeof proyectoId);
      console.log("  mes:", mes, "tipo:", typeof mes);
      console.log("  anio:", anio, "tipo:", typeof anio);

      // Validaciones
      if (!proyectoId || proyectoId === "" || proyectoId === undefined) {
        return alert("Debe seleccionar un proyecto primero");
      }
      if (!mes || mes === "") {
        return alert("Seleccione un mes");
      }
      if (!anio || anio === "") {
        return alert("Seleccione un año");
      }

      const proyectoIdInt = parseInt(proyectoId, 10);
      const mesInt = parseInt(mes, 10);
      const anioInt = parseInt(anio, 10);

      if (isNaN(proyectoIdInt) || isNaN(mesInt) || isNaN(anioInt)) {
        return alert("El proyecto, mes y año deben ser números válidos. Valores: proyecto=" + proyectoId + ", mes=" + mes + ", anio=" + anio);
      }

      // Recolectamos la información de la tabla de forma segura
      const filas = document.querySelectorAll("#tbodyAsistentes tr");
      const asistentesTabla = [];

      filas.forEach(tr => {
        // Saltamos filas de error o mensajes vacíos
        if (tr.cells.length < 3) return;

        asistentesTabla.push({
          id: tr.dataset.id === "NUEVO" ? null : parseInt(tr.dataset.id),
          nombre: tr.cells[1].innerText.trim(),
          cedula: tr.cells[2].innerText.trim(),
          // Buscamos el correo en el input oculto o usamos vacío
          correoPersonal: tr.querySelector(".hidden-correo")?.value || "",
          fechaNacimiento: tr.querySelector(".hidden-fecha-nac")?.value || "",
          tipoIntegrante: tr.querySelector(".hidden-tipo-integrante")?.value || "ASISTENTE",
          estado: tr.querySelector(".status-activo") ? "ACTIVO" : "FUERA_NOMINA"
        });
      });

      // Contar cambios
      const nuevosAsistentes = asistentesTabla.filter(a => a.id === null).length;
      const asistentesActivosPermanecen = asistentesTabla.filter(a => a.id !== null && a.estado === "ACTIVO").length;
      const asistentesdadosDeBaja = asistentesTabla.filter(a => a.id !== null && a.estado === "FUERA_NOMINA").length;

      // Mostrar resumen antes de confirmar
      let resumen = `Resumen de cambios:\n\n`;
      resumen += `✓ Nuevos asistentes: ${nuevosAsistentes}\n`;
      resumen += `✓ Asistentes activos: ${asistentesActivosPermanecen}\n`;
      resumen += `✗ Asistentes dados de baja: ${asistentesdadosDeBaja}\n\n`;
      resumen += `¿Confirmas la actualización de nómina?`;

      const confirmarCambios = confirm(resumen);
      if (!confirmarCambios) return;

      const payload = {
        proyectoId: proyectoIdInt,
        mes: mesInt,
        anio: anioInt,
        asistentes: asistentesTabla
      };

      console.log("Enviando al servidor:", payload);

      try {
        const res = await fetch("/api/nomina/confirmar-completo", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          const data = await res.json();
          
          // Obtener datos para mostrar en el modal
          const mesNombre = new Date(anioInt, mesInt - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
          const proyecto = document.getElementById("selectProyecto").selectedOptions[0].text;
          
          // Mostrar modal
          document.getElementById("mensajeModal").innerText = `Nómina del período ${mesNombre} actualizada con éxito`;
          document.getElementById("modalExito").classList.add("activo");
          
        } else {
          const errorStr = await res.text();
          alert("Error en el servidor: " + errorStr);
        }
      } catch (e) {
        alert("Error de conexión: " + e.message);
      }
    }

    function seleccionarPeriodo() {
      const pId = document.getElementById("selectProyecto").value;
      const mes = document.getElementById("mes").value;
      const anio = document.getElementById("anio").value;

      if (!pId || !mes || !anio) {
        alert("Por favor complete todos los campos: Proyecto, Mes y Año");
        return;
      }

      // Mostrar las secciones 2, 3 y 4
      document.getElementById("seccionContratacion").classList.remove("seccion-oculta");
      document.getElementById("seccionAsistentes").classList.remove("seccion-oculta");

      // Cargar asistentes para el período seleccionado
      cargarAsistentesDelProyecto();
    }

    // Función para cerrar el modal y limpiar
    function cerrarModal() {
      document.getElementById("modalExito").classList.remove("activo");
      
      // Ocultar las secciones 2 y 3
      document.getElementById("seccionContratacion").classList.add("seccion-oculta");
      document.getElementById("seccionAsistentes").classList.add("seccion-oculta");
      
      // Limpiar inputs
      document.getElementById("nomA").value = "";
      document.getElementById("cedA").value = "";
      document.getElementById("fechaNacA").value = "";
      
      // Resetear selects a estado inicial
      document.getElementById("mes").innerHTML = "<option value=''>Seleccione un año primero</option>";
      document.getElementById("anio").innerHTML = "<option value=''>Seleccione un año primero</option>";
      
      // Recargar meses
      cargarMesesAtrasados();
    }
  </script>
</body>

</html>